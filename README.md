# zipkin.NET
Zipkin instrumentation for .NET with support for .NET Core, OWIN and WCF.

Uses Zipkin V2 format.

## Server Span Tracing
Server spans tracers will build server spans from incoming requests using span context extracted from X-B3 HTTP headers. If no span context exists, a new span context will be created.

Span context is saved, usually to the current ``HttpContext``, using a ``ISpanContextAccessor`` so it can be accessed by client tracers.

Completed spans will be asynchronously forwarded to one or more ``IReporter``s by the dispatcher.

For .NET Core and OWIN, ``TracingMiddleware`` can be used to trace server spans

For WCF services, the ``ServiceTracingBehavior`` can be used to add a dispatch message inspector, ``DispatchTracingMessageInspector``, to build and report spans from incoming WCF requests.

## Client Span Tracing
Client span tracers will build client spans from outgoing requests and propagate span context by adding X-B3 HTTP headers.

The parent span context is accessed using the ``ISpanContextAccessor``. Usually, this will have been saved by a server tracer (e.g. middleware).

The ``TracingHandler`` is a delegating handler used to create client spans from outgoing HTTP requests send completed spans to available reporters.

For WCF clients, the ``EndpointTracingBehavior`` can be used to add a client message inspector, ``ClientTracingMessageInspector``, to build and report spans from outgoing WCF client requests.

## Reporters
Reporters receive completed spans generated by instrumentation.

The most important reporter is the ``ZipkinReporter``. This reporter will forward completed spans onto a Zipkin server using an ``ISender``.

Other reporters include the .NET Core ``LoggerReporter`` which logs completed spans using an ``ILogger`` and the ``ConsoleReporter`` which writes spans to standard out.


## Examples
See the [examples](examples) section for complete functional examples for .NET Core, OWIN, and WCF.

### .NET Core
Add dependencies to the service collection.
```csharp
// Register Zipkin server reporter.
// This reporter sends completed spans to a Zipkin 
// server's HTTP collector (POST api/v2/spans).
services.AddSingleton<IReporter>(provider =>
{
	var sender = new ZipkinHttpSender("http://localhost:9411");
	var reporter = new ZipkinReporter(sender);
	return reporter;
});

// Register .NET Core ILogger span reporter.
// This reporter logs completed spans using the .NET Core ILogger.
services.AddSingleton<IReporter, LoggerReporter>();

// Register default tracing dependencies.
services.AddTracing("example-api", 1f);
```

Add the ```TracingMiddleware``` to the pipeline.
```csharp
// Middleware builds server spans from incoming requests
// and reports them using the registered dispatcher.
app.UseMiddleware<TracingMiddleware>();
```
Using the ```HttpClientFactory```, create an HTTP client with a ```TracingHandler```.
```csharp
// The TracingHandler builds client spans from outgoing HTTP
// requests and reports them using the registered dispatcher.
services.AddHttpClient("my-http-client").AddTracingMessageHandler("my-other-api");
```
### OWIN
Register dependencies, for example, if using Autofac.
```csharp
var builder = new ContainerBuilder();
builder.Register(ctx => new ZipkinHttpSender("http://localhost:9411")).As<ISender>().SingleInstance();
builder.RegisterType<AsyncActionBlockDispatcher>().As<IDispatcher>().SingleInstance();
builder.RegisterType<CallContextTraceContextAccessor>().As<ITraceContextAccessor>().SingleInstance();
builder.RegisterType<ConsoleInstrumentationLogger>().As<IInstrumentationLogger>().SingleInstance();
builder.RegisterType<RateSampler>().As<ISampler>().WithParameter("rate", 1f).SingleInstance();
builder.RegisterType<ConsoleReporter>().As<IReporter>().SingleInstance();
builder.RegisterType<ZipkinReporter>().As<IReporter>().SingleInstance();
builder.RegisterType<TracingMiddleware>().WithParameter("localEndpointName", "owin-api");
```
Add the OWIN ```TracingMiddleware``` to the pipeline.
```csharp
app.UseMiddlewareFromContainer<TracingMiddleware>();
```
